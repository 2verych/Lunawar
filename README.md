# Технический план разработки движка браузерной многопользовательской игры

## Описание проекта (User Story)

Мы создаём движок для браузерной многопользовательской игры. Это будет клиент-серверное приложение с веб-интерфейсом для игроков и отдельной админкой для разработчиков и администраторов.

## История использования

Игрок открывает сайт игры.
Он видит лендинг с кнопкой авторизации через Google и список уже созданных комнат.

Если игрок не авторизован — он нажимает кнопку "Войти через Google".

После успешного входа система получает его email (уникальный ID) и имя (или присваивает "Noname").

После входа игрок видит:

- Список активных комнат — может присоединиться к любой.
- Кнопку "Join Lobby" — чтобы встать в очередь на подбор игроков.
- Лобби — это список пользователей, которые ждут других игроков для игры.

Когда в лобби набирается достаточно человек, система автоматически создаёт комнату (если включено автоформирование) или администратор делает это вручную.

Игроки из лобби перемещаются в новую комнату.

### Комната

- Внутри комнаты пока есть только чат.
- На экране игрок видит чёрный фон и мини-чат в углу с тремя последними сообщениями.
- Если нажать клавишу <code>```</code>, открывается полный чат: история сообщений и возможность писать.

### Выход из комнаты

- Игрок может покинуть комнату.
- Если из комнаты вышли все пользователи, комната удаляется автоматически.

### Администратор

Через админку может:

- Видеть список игроков в лобби.
- Настраивать размер комнаты.
- Включать или выключать автоматическое формирование комнат.
- Создавать комнаты вручную.
- Смотреть список всех активных комнат.

Админка тоже работает через WebSocket и всегда показывает актуальное состояние.

### Авторизация и уникальность сессий

- Каждый пользователь идентифицируется по email из Google OAuth.
- Если пользователь входит с другого устройства или браузера, система автоматически завершает его предыдущую сессию и удаляет его из всех лобби и комнат.

## Технический стек

- Backend: Node.js + Express.
- Frontend: React + Vite.
- Хранилище: Redis (все состояния эфемерные, без истории).
- Авторизация: Google OAuth 2.0.
- Протокол обновлений: WebSocket.
- Деплой: Docker + Nginx.

## План разработки

1. **Структура репозитория**

   - Создать монорепозиторий game-engine-js-node.
   - Структура папок:

```
apps/
  server/    → backend
  web/       → клиентская часть
  admin/     → админка
packages/
  shared/    → общие типы, локализация, утилиты
infra/       → конфигурация Docker и деплоя
```

   - Создать .env.example с шаблоном переменных окружения.
   - Добавить README.md с описанием проекта.

   Зачем: чтобы с самого начала была понятная структура и проще поддерживать проект.

2. **Инфраструктура**

   - Docker Compose:
     - Сервисы: api, web, admin, redis.
     - Сеть: game-net.
     - Redis LTS с паролем из .env.
   - Настроить Makefile:
     - `make up` — запуск.
     - `make down` — остановка.
     - `make logs` — просмотр логов.

   Зачем: быстро разворачиваем локальную среду разработки.

3. **Общие сущности**

   - Вынести в packages/shared:
     - Типы данных: User, Room, Message.
     - Типы событий: lobby.joined, room.created, chat.message.
     - Функцию локализации `l(key, fallback)`.
   - Задать схему ключей Redis:
     - `lobby:queue`
     - `room:{id}:users`
     - `room:{id}:messages`
     - `room:{id}:meta`
     - `config:roomSize`
     - `config:autoMatch`
     - `user:{email}:session`

   Зачем: единый набор типов и ключей исключает путаницу.

4. **Сервер (apps/server)**

   - Создать каркас проекта на Node.js + Express.
   - Подключить ioredis для работы с Redis.
   - Создать глобальный обработчик ошибок.
   - Добавить `GET /health` для проверки состояния сервера.

   Зачем: базовый каркас позволит постепенно наращивать функционал.

5. **Авторизация через Google**

   - Подключить Google OAuth.
   - API:
     - `POST /auth/google` — принимает id_token, верифицирует его через Google API.
       Создаёт sessionId и сохраняет в Redis: `user:{email}:session`.
       Возвращает cookie с флагом httpOnly.
     - `GET /me` — получить текущего пользователя.
   - При входе с нового устройства:
     - Завершить старую сессию.
     - Удалить пользователя из лобби и комнат.

   Зачем: email пользователя — уникальный ID, авторизация максимально простая.

6. **WebSocket**

   - Поднять endpoint `/ws` для WebSocket.
   - Клиент после подключения отправляет подписку на каналы: `user`, `room`, `lobby`, `admin`.
   - Сервер отправляет события по мере их появления.
   - Поддержка восстановления при разрыве соединения.

   Зачем: обеспечиваем обновления интерфейса в реальном времени.

7. **Лобби и комнаты**

   - Создать очередь `lobby:queue`.
   - API:
     - `POST /lobby/join` — встать в очередь.
     - `POST /lobby/leave` — выйти из очереди.
     - `GET /lobby` — список игроков.
   - Создать механику создания комнат:
     - Автоматически: если включено `config:autoMatch`.
     - Ручное: по кнопке администратора.
   - Структура комнаты:
     - `room:{id}:meta` — метаданные.
     - `room:{id}:users` — список участников.
     - `room:{id}:messages` — чат.
   - Автоматическое закрытие комнаты, если в ней нет пользователей.

   Зачем: реализуем основную механику объединения игроков.

8. **Чат**

   - Хранить последние N сообщений в Redis.
   - API `POST /rooms/:id/chat.send` — отправка сообщения.
  - WebSocket-событие `chat.message` для всех участников комнаты.
   - Мини-чат на клиенте отображает 3 последних сообщения.
   - Полный чат открывается по клавише <code>```</code>, поддерживает прокрутку.

   Зачем: чат — первый функционал взаимодействия игроков.

9. **Админка**

   - Создать `apps/admin` на React + Vite.
   - API:
     - `GET /admin/lobby` — список игроков.
     - `GET /admin/rooms` — список комнат.
     - `POST /admin/room.create` — создать комнату вручную.
     - `POST /admin/config.set` — задать размер комнаты и режим автосоздания.
   - Интерфейс:
     - Таб "Lobby" — список игроков в лобби.
     - Таб "Rooms" — список активных комнат.
     - Таб "Config" — настройки размера комнаты и автоформирования.

   Зачем: нужна для тестирования, отладки и управления игрой.

10. **Фронтенд для игроков**

    - Создать `apps/web` на React + Vite.
    - Страницы:
      - **Landing**:
        - Авторизация через Google.
        - Список комнат.
        - Кнопка "Join Lobby".
      - **Lobby**:
        - Список игроков.
        - Ожидание создания комнаты.
      - **Room**:
        - Чёрный экран.
        - Мини-чат.
        - Полный чат по клавише <code>```</code>.
        - Кнопка выхода.

    Зачем: основной клиентский интерфейс для игроков.

11. **Локализация**

    - Создать функцию `l(key, fallback)` в `packages/shared`.
    - Добавить словарь `en.json`.
    - Все тексты вызывать через `l("game.chat.hello", "Hello")`.

    Зачем: можно легко добавить другие языки позже.

12. **Деплой**

    - Собрать Docker-образы api, web, admin.
    - Поднять Nginx как reverse-proxy:
      - api на `/api`.
      - web и admin раздавать как статику.
    - Redis вынести в контейнер или managed-сервис.

    Зачем: упрощаем деплой и настройку окружений.

13. **MVP критерии**

    - Авторизация через Google.
    - Лобби с автосозданием комнат.
    - Ручное создание комнаты через админку.
    - Мини-чат и полный чат.
    - Автоматическое закрытие пустых комнат.
    - Обновления через WebSocket.
    - Админка с настройками.


## Структура репозитория

```
apps/
  server/    - backend application
  web/       - player-facing frontend
  admin/     - administration panel
packages/
  shared/    - shared utilities and types
infra/       - infrastructure and deployment configs
```

Монорепозиторий использует npm workspaces для управления зависимостями.
